{#
/**
 * @file
 * Template for Media Album Light Table with Field Groups.
 *
 * Available variables:
 * - view: The view object.
 * - groups: Hierarchical array of grouped media.
 * - options: Style plugin options including field_groups configuration.
 */
#}
{# Extract variables from options for cleaner code #}
{% set columns = options.columns|default(4) %}
{% set gap = options.gap|default('20px') %}
{% set justify = options.justify|default('flex-start') %}
{% set align = options.align|default('stretch') %}
{% set field_mapping_config = options.field_mapping|default({}) %}

{# Macro to render media items with field groups #}
{% macro render_media_item(media_item, columns, gap, field_mapping_config, view, group) %}
	{% set infos = media_item.media %}
	{% set thumbnail = media_item.thumbnail %}
	{% set image_alt = infos.fields.name|default('') %}

	{% set row_index = media_item.row_index %}

	<div
		class="draggable-flexgrid__item media-item js-draggable-item media-light-table-media-item" data-entity-id="{{ infos.id }}" data-id="{{ infos.id }}" data-media-id="{{ infos.id }}" style="flex: 0 0 calc(100% / {{ columns }} - {{ gap }});">

		{# Main content area with groups #}
		<div
			class="draggable-flexgrid__content">

			{# Thumbnail Field #}
			{% if field_mapping_config.thumbnail.enabled %}
				<div class="draggable-flexgrid__group-1 media-light-table-thumbnail-field">
					<div class="draggable-flexgrid__thumbnail media-light-table-thumbnail" data-orig-field-type="{{ group.field_type }}" data-orig-field-name="{{ group.field_name }}">
						<span class="field-content media-light-field-content">
							<img src="{{ thumbnail.thumbnail_url }}" alt="{{ image_alt }}" title="{{ infos.label }} ({{ 'ID' }}: {{ infos.id }})" width="{{ thumbnail.thumbnail_width }}" height="{{ thumbnail.thumbnail_height }}" class="draggable-flexgrid__image media-light-table-image"/>
						</span>
					</div>
				</div>
			{% endif %}

			{# Name Field #}
			{% if field_mapping_config.name.enabled %}
				<div
					class="draggable-flexgrid__group-3 media-light-table-name-field">
					{# Rendre le vrai champ name #}
					<span class="field-content media-light-field-content">
						{{ view.style_plugin.getField(row_index, field_mapping_config.name.field) }}
					</span>
				</div>
			{% endif %}

			{# VBO Actions Field #}
			{% if field_mapping_config.vbo.enabled %}
				<div class="draggable-flexgrid__group-2 media-light-table-vbo-field">
					<span
						class="field-content media-light-field-content">
						{# Rendre le vrai champ VBO #}
						{{ view.style_plugin.getField(row_index, field_mapping_config.vbo.field) }}
					</span>
				</div>
			{% endif %}

			{# Action Field #}
			{% if field_mapping_config.action.enabled %}
				<div class="draggable-flexgrid__group-5 media-light-table-action-field">
					<span
						class="field-content media-light-field-content">
						{# Rendre le vrai champ action #}
						{{ view.style_plugin.getField(row_index, field_mapping_config.action.field) }}
					</span>
				</div>
			{% endif %}

			{# Media Details - reste inchangé #}
			{% if field_mapping_config.details.enabled %}
				<div class="media-light-table-info-wrapper media-light-table-details-field" data-once="entity-popup">
					<button type="button" class="media-light-table-info-button">{{ 'More...'|t }}</button>
					<div class="media-light-table-info-popup">
						<span class="media-light-table-image-id media-light-table-popup-field">
							<strong>{{ 'ID'|t }}:</strong>
							{{ infos.id }}
						</span>
						<span class="media-light-table-image-filepath media-light-table-popup-field">
							<strong>{{ 'Path'|t }}:</strong>
							{{ infos.file_path }}
						</span>
						<span class="media-light-table-image-size media-light-table-popup-field">
							<strong>{{ 'Size'|t }}:</strong>
							{{ (infos.size_bytes / 1024 / 1024)|round(2) }}
							MB
						</span>
						<span class="media-light-table-image-mime-type media-light-table-popup-field">
							<strong>{{ 'MIME'|t }}:</strong>
							{{ infos.mime_type }}
						</span>
						{% if infos.width > 0 and infos.height > 0 %}
							<span class="media-light-table-image-dimensions media-light-table-popup-field">
								<strong>{{ 'Dimensions'|t }}:</strong>
								{{ infos.width }}x{{ infos.height }}
							</span>
						{% endif %}
						<span class="media-light-table-image-name media-light-table-popup-field">
							<strong>{{ 'Name'|t }}:</strong>
							{{ infos.file_name }}
						</span>
						{% if infos.bundle %}
							<span class="media-light-table-image-bundle media-light-table-popup-field">
								<strong>{{ 'Media Type'|t }}:</strong>
								{{ infos.bundle }}
							</span>
						{% endif %}
					</div>
				</div>
			{% endif %}
		</div>

		{# Right side menu: drag handle and zoom button #}
		<div class="draggable-flexgrid__menu-handle" title="{{ 'Action menu'|t }}">
			<div class="media-light-table-drag-icon draggable-flexgrid__menu-button draggable-flexgrid__handle" title="{{ 'Drag to reorder'|t }}">
				<svg class="drag-icon" width="1.8rem" height="1.8rem" viewbox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					{# Arrows positioned at extremes #}
					{# Top #}
					<line x1="16" y1="6" x2="16" y2="14"/> <polyline
					points="12,10 16,6 20,10"/>
					{# Bottom #}
					<line x1="16" y1="26" x2="16" y2="18"/>
					<polyline
					points="12,22 16,26 20,22"/>
					{# Left #}
					<line x1="6" y1="16" x2="14" y2="16"/>
					<polyline
					points="10,12 6,16 10,20"/>
					{# Right #}
					<line x1="26" y1="16" x2="18" y2="16"/>
					<polyline points="22,12 26,16 22,20"/>
				</svg>
			</div>
			<div class="media-light-table-zoom-trigger draggable-flexgrid__menu-button" role="button" tabindex="0" title="{{ 'View full size'|t }}" aria-label="{{ 'View full size'|t }}" data-image-src="{{ infos.url }}" data-image-alt="{{ image_alt }}" data-mime-type="{{ infos.mime_type }}" data-media-type="{{ infos.mime_type|split('/')|first }}">
				<svg class="zoom-icon" width="1.8rem" height="1.8rem" viewbox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<circle cx="11" cy="11" r="8"/>
					<line x1="19" y1="19" x2="28" y2="28" stroke-width="3"/>
					<line x1="18" y1="20" x2="27" y2="29" stroke-width="1.5" opacity="0.8"/>
					<line x1="11" y1="7" x2="11" y2="15"/>
					<line x1="7" y1="11" x2="15" y2="11"/>
				</svg>
			</div>
		</div>

	</div>
{% endmacro %}

{# Macro to render albums in grids #}
{% macro render_albums(group, columns, gap, field_mapping_config, view, display_group = true) %}
	{# display the album container only if display_group is true or if there are medias in the album #}
	{% set albums = group.albums| default([]) %}
	{% set album_group = group.album_group|default('') %}
	{% set termid = group.termid|default('') %}
	{% set nid = group.nid|default(-1) %}

	{% if display_group == true or albums|length > 0 %}
		{% if albums|length == 0 %}
			{# only taxonmy are elligible to be draggable #}
			{% if group.field_target_type == "taxonomy_term" %}
				<div class="media-grid media-light-table-album-container  {% if group.field_target_type == " taxonomy_term" %}album-group-{{ album_group }} js-draggable-flexgrid draggable-flexgrid__grid {% endif %} empty-state" data-album-id="empty-album" data-album-grp="album-group-{{ album_group }}" data-termid="{{ termid }}" data-nid="{{ nid }}" data-columns="{{ columns }}" data-gap="{{ gap }}" data-field-type="{{ group.field_type }}" data-field-name="{{ group.field_name }}" style="display: flex; flex-wrap: wrap; gap: {{ gap }};" data-level="{{ group.level }}"></div>
			{% endif %}
		{% else %}
			{% for album in albums %}
				<div class="media-grid media-light-table-album-container  {% if group.field_target_type == " taxonomy_term" %}album-group-{{ album_group }} js-draggable-flexgrid draggable-flexgrid__grid {% endif %}{% if not album.medias %} empty-state{% endif %}" data-album-id="{{ album.id }}" data-album-grp="album-group-{{ album_group }}" data-termid="{{ termid }}" data-nid="{{ nid }}" data-gap="{{ gap }}" data-field-type="{{ group.field_type }}" data-field-name="{{ group.field_name }}" style="display: flex; flex-wrap: wrap; gap: {{ gap }};" data-level="{{ group.level }}">
					{% if album.medias %}
						{% for media_item in album.medias %}
							{# Passer view et row_index à la macro #}
							{{ _self.render_media_item(media_item, columns, gap, field_mapping_config, view, group) }}
						{% endfor %}
					{% endif %}
				</div>
			{% endfor %}
		{% endif %}
	{% else %}
		{{ '' }}
	{% endif %}
{% endmacro %}

{# Macro to recursively render groups #}
{# Macro to recursively render groups #}
{% macro render_group_recursive(group, columns, gap, field_mapping_config, view) %}
	{# Only render the group wrapper if it has content #}
	{% if group.albums|length > 0 or (group.subgroups and group.subgroups|length > 0) %}
		<div class="draggable-flexgrid__group-wrapper media-light-table-group-wrapper" data-level="{{ group.level }}" style="--level: {{ group.level }};">
			<span class="draggable-flexgrid__grouping-name media-light-table-grouping-name" data-level="{{ group.level }}">
				{{ group.taxo_name }}
			</span>

			<div class="draggable-flexgrid__group-header media-light-table-group-header">
				<div class="draggable-flexgrid__group-title media-light-table-group-title" data-level="{{ group.level }}">
					{{ group.group_title }}
				</div>
				<div class="draggable-flexgrid__group-commands media-light-table-group-commands">
					{{ group.commandes|raw }}
				</div>
			</div>

			<div class="draggable-flexgrid__group-content media-light-table-group-content" data-level="{{ group.level }}">
				{# Render albums at this level #}
				{{ _self.render_albums(group, columns, gap, field_mapping_config, view, true) }}

				{# Render subgroups recursively - INSIDE the content #}
				{% if group.subgroups and group.subgroups|length > 0 %}
					{% for subgroup in group.subgroups %}
						{# Recursively render subgroup - will create its own wrapper #}
						{{ _self.render_group_recursive(subgroup, columns, gap, field_mapping_config, view) }}
					{% endfor %}
				{% endif %}
			</div>
		</div>
	{% endif %}
{% endmacro %}

{# Main container #}
<div class="draggable-flexgrid light-table-content draggable-flexgrid draggable-flexgrid--{{ columns }}cols" data-view-id="{{ view.id }}" data-display-id="{{ view.current_display }}" data-columns="{{ columns }}" data-gap="{{ gap }}" style="display: flex; flex-wrap: wrap; gap: {{ gap }}; justify-content: {{ justify }}; align-items: {{ align }};">

	<input type="hidden" name="media-light-table-vbo-order" class="media-light-table-vbo-order" value="">

	{% if groups is empty %}
		<div class="draggable-flexgrid__empty">
			{{ 'No content available.'|t }}
		</div>
	{% else %}
		{% for group in groups %}
			<div class="draggable-flexgrid__group-container media-light-table-group">
				<span class="draggable-flexgrid__group-album-title media-light-table-group-album-title">
					{{ group.node_title }}
				</span>
				<div class="draggable-flexgrid__group-commandes media-light-table-group-commandes"></div>
				{{ _self.render_group_recursive(group, columns, gap, field_mapping_config, view) }}
			</div>
		{% endfor %}
	{% endif %}
</div>
